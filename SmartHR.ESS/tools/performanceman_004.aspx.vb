Imports System.Web.HttpUtility

Partial Public Class performanceman_0041
    Inherits System.Web.UI.Page

#Region " *** Web Form Events *** "

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        'select cast(newid() as nvarchar(36)) as [ID], [ps].[EvalDate], [pc].[CompanyNum] + ' ' + [pc].[EmployeeNum] + ' ' + [pc].[SchemeCode] + ' ' + convert(nvarchar(19), [pc].[EvalDate], 120) + ' ' + [ClassCode] as [CompositeKey], 0 as [Type], [ClassCode], null as [Sort], upper([ClassName]) as [Name], '' as [RangeType], '' as [Value], [Weight], [RatingPercentage], [pc].[Score], '' as [Description], '' as [Desc], [pc].[EvalDate] as [ObtainBy], 0 as [Count], '' as [Answers], '' as [Answers_010], '' as [Answers_011], '' as [Answers_012], isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), '') as [Employee], [CostCentre], (select top 1 isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), '') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = 'Organogram')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalClass] as [pc] left outer join [PerfEvalScheme] as [ps] on [pc].[CompanyNum] = [ps].[CompanyNum] and [pc].[EmployeeNum] = [ps].[EmployeeNum] and [pc].[SchemeCode] = [ps].[SchemeCode] and [pc].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pc].[CompanyNum] = [e].[CompanyNum] and [pc].[EmployeeNum] = [e].[EmployeeNum] where ([PathID] = <%PARAM[0]%>) union select null, [ps].[EvalDate], [pk].[CompanyNum] + ' ' + [pk].[EmployeeNum] + ' ' + [pk].[SchemeCode] + ' ' + convert(nvarchar(19), [pk].[EvalDate], 120) + ' ' + [ClassCode] + ' ' + [KPACode], 1, [ClassCode], [KPACode], upper([KPAName]), isnull([RangeType], ''), [ElementName], [Weight], [RatingPercentage], [pk].[Score], convert(nvarchar(4000), [pk].[Remarks]), (select isnull([Description], '') from [PerfKPA] where [SchemeCode] = [pk].[SchemeCode] and [ClassCode] = [pk].[ClassCode] and [KPACode] = [pk].[KPACode]), [ObtainBy], (select count([CSEName]) from [PerfEvalCSE] where ([SchemeCode] = [pk].[SchemeCode] and [ClassCode] = [pk].[ClassCode] and [KPACode] = [pk].[KPACode])), '', '', '', '', isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), ''), [CostCentre], (select top 1 isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), '') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = 'Organogram')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalKPA] as [pk] left outer join [PerfEvalScheme] as [ps] on [pk].[CompanyNum] = [ps].[CompanyNum] and [pk].[EmployeeNum] = [ps].[EmployeeNum] and [pk].[SchemeCode] = [ps].[SchemeCode] and [pk].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pk].[CompanyNum] = [e].[CompanyNum] and [pk].[EmployeeNum] = [e].[EmployeeNum] where ([pk].[CompanyNum] + ' ' + [pk].[EmployeeNum] + ' ' + [pk].[SchemeCode] + ' ' + convert(nvarchar(19), [pk].[EvalDate], 120) = (select top 1 [CompanyNum] + ' ' + [EmployeeNum] + ' ' + [SchemeCode] + ' ' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) union select null, [ps].[EvalDate], [pcs].[CompanyNum] + ' ' + [pcs].[EmployeeNum] + ' ' + [pcs].[SchemeCode] + ' ' + convert(nvarchar(19), [pcs].[EvalDate], 120) + ' ' + [ClassCode] + ' ' + [KPACode] + ' ' + [CSEName], 2, [ClassCode], [KPACode], [CSEName], isnull([RangeType], ''), [ElementName], [Weight], [RatingPercentage], [pcs].[Score], convert(nvarchar(4000), [pcs].[Remarks]), (select isnull([Description], '') from [PerfCSE] where [SchemeCode] = [pcs].[SchemeCode] and [ClassCode] = [pcs].[ClassCode] and [KPACode] = [pcs].[KPACode] and [CSEName] = [pcs].[CSEName]), [ObtainBy], 0, '', '', '', '', isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), ''), [CostCentre], (select top 1 isnull([Title] + ' ', '') + isnull([Surname] + ', ', '') + isnull(isnull([PreferredName], [FirstName]), '') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = 'Organogram')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalCSE] as [pcs] left outer join [PerfEvalScheme] as [ps] on [pcs].[CompanyNum] = [ps].[CompanyNum] and [pcs].[EmployeeNum] = [ps].[EmployeeNum] and [pcs].[SchemeCode] = [ps].[SchemeCode] and [pcs].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pcs].[CompanyNum] = [e].[CompanyNum] and [pcs].[EmployeeNum] = [e].[EmployeeNum] where ([pcs].[CompanyNum] + ' ' + [pcs].[EmployeeNum] + ' ' + [pcs].[SchemeCode] + ' ' + convert(nvarchar(19), [pcs].[EvalDate], 120) = (select top 1 [CompanyNum] + ' ' + [EmployeeNum] + ' ' + [SchemeCode] + ' ' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) order by [ClassCode], [Sort], [Type], [Name]

        'select cast(newid() as nvarchar(36)) as [ID], [ps].[EvalDate], [pc].[CompanyNum] + '' '' + [pc].[EmployeeNum] + '' '' + [pc].[SchemeCode] + '' '' + convert(nvarchar(19), [pc].[EvalDate], 120) + '' '' + [ClassCode] as [CompositeKey], 0 as [Type], [ClassCode], null as [Sort], upper([ClassName]) as [Name], '''' as [RangeType], '''' as [Value], [Weight], [RatingPercentage], [pc].[Score], '''' as [Description], '''' as [Desc], [pc].[EvalDate] as [ObtainBy], 0 as [Count], '''' as [Answers], '''' as [Answers_010], '''' as [Answers_011], '''' as [Answers_012], isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), '''') as [Employee], [CostCentre], (select top 1 isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), '''') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = ''Organogram'')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalClass] as [pc] left outer join [PerfEvalScheme] as [ps] on [pc].[CompanyNum] = [ps].[CompanyNum] and [pc].[EmployeeNum] = [ps].[EmployeeNum] and [pc].[SchemeCode] = [ps].[SchemeCode] and [pc].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pc].[CompanyNum] = [e].[CompanyNum] and [pc].[EmployeeNum] = [e].[EmployeeNum] where ([PathID] = <%PARAM[0]%>) union select null, [ps].[EvalDate], [pk].[CompanyNum] + '' '' + [pk].[EmployeeNum] + '' '' + [pk].[SchemeCode] + '' '' + convert(nvarchar(19), [pk].[EvalDate], 120) + '' '' + [ClassCode] + '' '' + [KPACode], 1, [ClassCode], [KPACode], upper([KPAName]), isnull([RangeType], ''''), [ElementName], [Weight], [RatingPercentage], [pk].[Score], convert(nvarchar(4000), [pk].[Remarks]), (select isnull([Description], '''') from [PerfKPA] where [SchemeCode] = [pk].[SchemeCode] and [ClassCode] = [pk].[ClassCode] and [KPACode] = [pk].[KPACode]), [ObtainBy], (select count([CSEName]) from [PerfEvalCSE] where ([SchemeCode] = [pk].[SchemeCode] and [ClassCode] = [pk].[ClassCode] and [KPACode] = [pk].[KPACode])), '''', '''', '''', '''', isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), ''''), [CostCentre], (select top 1 isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), '''') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = ''Organogram'')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalKPA] as [pk] left outer join [PerfEvalScheme] as [ps] on [pk].[CompanyNum] = [ps].[CompanyNum] and [pk].[EmployeeNum] = [ps].[EmployeeNum] and [pk].[SchemeCode] = [ps].[SchemeCode] and [pk].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pk].[CompanyNum] = [e].[CompanyNum] and [pk].[EmployeeNum] = [e].[EmployeeNum] where ([pk].[CompanyNum] + '' '' + [pk].[EmployeeNum] + '' '' + [pk].[SchemeCode] + '' '' + convert(nvarchar(19), [pk].[EvalDate], 120) = (select top 1 [CompanyNum] + '' '' + [EmployeeNum] + '' '' + [SchemeCode] + '' '' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) union select null, [ps].[EvalDate], [pcs].[CompanyNum] + '' '' + [pcs].[EmployeeNum] + '' '' + [pcs].[SchemeCode] + '' '' + convert(nvarchar(19), [pcs].[EvalDate], 120) + '' '' + [ClassCode] + '' '' + [KPACode] + '' '' + [CSEName], 2, [ClassCode], [KPACode], [CSEName], isnull([RangeType], ''''), [ElementName], [Weight], [RatingPercentage], [pcs].[Score], convert(nvarchar(4000), [pcs].[Remarks]), (select isnull([Description], '''') from [PerfCSE] where [SchemeCode] = [pcs].[SchemeCode] and [ClassCode] = [pcs].[ClassCode] and [KPACode] = [pcs].[KPACode] and [CSEName] = [pcs].[CSEName]), [ObtainBy], 0, '''', '''', '''', '''', isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), ''''), [CostCentre], (select top 1 isnull([Title] + '' '', '''') + isnull([Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), '''') from [ReportsTo] as [rep] left outer join [Personnel] as [e] on [rep].[ReportToCompNum] = [e].[CompanyNum] and [rep].[ReportToEmpNum] = [e].[EmployeeNum] where ([rep].[CompanyNum] = [ps].[CompanyNum] and [rep].[EmployeeNum] = [ps].[EmployeeNum] and [ReportsToType] = ''Organogram'')) as [ReportsTo], [JobTitle], [AppraiserType], [AppraiserName], [ps].[EmployeeNum], [ps].[Name] as [Scheme], [ps].[Score] as [SchemeScore] from ([PerfEvalCSE] as [pcs] left outer join [PerfEvalScheme] as [ps] on [pcs].[CompanyNum] = [ps].[CompanyNum] and [pcs].[EmployeeNum] = [ps].[EmployeeNum] and [pcs].[SchemeCode] = [ps].[SchemeCode] and [pcs].[EvalDate] = [ps].[EvalDate]) left outer join [Personnel] as [e] on [pcs].[CompanyNum] = [e].[CompanyNum] and [pcs].[EmployeeNum] = [e].[EmployeeNum] where ([pcs].[CompanyNum] + '' '' + [pcs].[EmployeeNum] + '' '' + [pcs].[SchemeCode] + '' '' + convert(nvarchar(19), [pcs].[EvalDate], 120) = (select top 1 [CompanyNum] + '' '' + [EmployeeNum] + '' '' + [SchemeCode] + '' '' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) order by [ClassCode], [Sort], [Type], [Name]

        'update [ess.ReportsLU] set [SQL] = 'select cast(newid() as nvarchar(36)) as [ID], [pClass].[CompanyNum] + ''?'' + [pClass].[EmployeeNum] + ''?'' + [pClass].[SchemeCode] + ''?'' + convert(nvarchar(19), [pClass].[EvalDate], 120) + ''?'' + [ClassCode] as [CompositeKey], 0 as [Type], [ClassCode], null as [Sort], [ClassName] as [Name], '''' as [RangeType], '''' as [Value], [Weight], [RatingPercentage], [pClass].[Score], ''-'' as [Description], [pClass].[EvalDate] as [ObtainBy], 0 as [Count], '''' as [Answers], '''' as [Answers_010], '''' as [Answers_011], '''' as [Answers_012], ''Appraisal for'' + isnull('' '' + [Title], '''') + isnull('' '' + [Surname] + '', '', '''') + isnull(isnull([PreferredName], [FirstName]), '''') as [Employee], [DeptName], [AppraiserType], [AppraiserName], [Appointdate], [pScheme].[Name] as [Scheme], [pScheme].[Score] as [SchemeScore], ''-'' as [StickyNotes] from ([PerfEvalClass] as [pClass] left outer join [PerfEvalScheme] as [pScheme] on [pClass].[CompanyNum] = [pScheme].[CompanyNum] and [pClass].[EmployeeNum] = [pScheme].[EmployeeNum] and [pClass].[SchemeCode] = [pScheme].[SchemeCode] and [pClass].[EvalDate] = [pScheme].[EvalDate]) left outer join [Personnel] as [emp] on [pClass].[CompanyNum] = [emp].[CompanyNum] and [pClass].[EmployeeNum] = [emp].[EmployeeNum] where ([PathID] = <%PARAM[0]%>) union select null, [CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) + ''?'' + [ClassCode] + ''?'' + [KPACode], 1, [ClassCode], [KPACode], [KPAName], [RangeType], [ElementName], [Weight], [RatingPercentage], [Score], cast(isnull([Remarks], ''-'') as varchar(8000)), [ObtainBy], (select count([CSEName]) from [PerfEvalCSE] where ([SchemeCode] = [PerfEvalKPA].[SchemeCode] and [ClassCode] = [PerfEvalKPA].[ClassCode] and [KPACode] = [PerfEvalKPA].[KPACode])), '''', '''', '''', '''', null, null, null, null, null, null, (select [Score] from [PerfEvalScheme] where ([CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) = [PerfEvalKPA].[CompanyNum] + ''?'' + [PerfEvalKPA].[EmployeeNum] + ''?'' + [PerfEvalKPA].[SchemeCode] + ''?'' + convert(nvarchar(19), [PerfEvalKPA].[EvalDate], 120))), cast(isnull([StickyNotes], ''-'') as varchar(8000)) from [PerfEvalKPA] where ([CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) = (select [CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) union select null, [CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) + ''?'' + [ClassCode] + ''?'' + [KPACode] + ''?'' + [CSEName], 2, [ClassCode], [KPACode], [CSEName], [RangeType], [ElementName], [Weight], [RatingPercentage], [Score], cast(isnull([Remarks], ''-'') as varchar(8000)), [ObtainBy], 0, '''', '''', '''', '''', null, null, null, null, null, null, (select [Score] from [PerfEvalScheme] where ([CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) = [PerfEvalCSE].[CompanyNum] + ''?'' + [PerfEvalCSE].[EmployeeNum] + ''?'' + [PerfEvalCSE].[SchemeCode] + ''?'' + convert(nvarchar(19), [PerfEvalCSE].[EvalDate], 120))), cast(isnull([StickyNotes], ''-'') as varchar(8000)) from [PerfEvalCSE] where ([CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) = (select [CompanyNum] + ''?'' + [EmployeeNum] + ''?'' + [SchemeCode] + ''?'' + convert(nvarchar(19), [EvalDate], 120) from [PerfEvalScheme] where ([PathID] = <%PARAM[0]%>))) order by [ClassCode], [Sort], [Type], [Name]' where ([ID] = 2)

        'update [PerfScheme] set [ESSCreated] = 1

        'update [PerfSchemeClass] set [ClassCode] = 'ESS', [Weight] = 100

        If (Not IsPostBack) Then

            Dim EvalDate() As Date = {GetSQLField("select [EvalDate] from [PerfEvalScheme] where ([PathID] = " & Session("PathID") & " and [GroupRole] = (select [ReportsToType] from [ess.ActionLU] where ([ID] = (select [ActionID] from [ess.WF] where ([ID] = (select [WFID] from [ess.Path] where ([ID] = " & Session("PathID") & ")))))))", "EvalDate"), GetSQLField("select [EvalDate] from [PerfEvalScheme] where ([PathID] = " & Session("PathID") & ")", "EvalDate")}

            Dim EmployeeNum As String = GetSQLField(String.Format("SELECT EmployeeNum FROM PerfEvalScheme Where PathID={0}", Session("PathID")), "EmployeeNum").ToString()

            Dim tbReportingTo As DataTable = GetSQLDT(String.Format("SELECT * FROM ReportsTo WHERE ReportToEmpNum='{0}'", EmployeeNum), "")

            cmdEvaluation.Visible = tbReportingTo.Rows.Count > 0


            If (Not IsDate(EvalDate(0))) Then EvalDate(0) = Nothing

            If (Not IsDate(EvalDate(1))) Then EvalDate(1) = Nothing

            If (Not IsDate(EvalDate(0)) AndAlso IsDate(EvalDate(1))) Then EvalDate(0) = EvalDate(1)

            If (GetArrayItem(Session("Managed").Template, "ePerformance.ShowScore")) Then

                Dim Score() As Single = {GetSQLField("select [Score] from [PerfEvalScheme] where ([PathID] = " & Session("PathID") & " and [GroupRole] = (select [ReportsToType] from [ess.ActionLU] where ([ID] = (select [ActionID] from [ess.WF] where ([ID] = (select [WFID] from [ess.Path] where ([ID] = " & Session("PathID") & ")))))))", "Score"), GetSQLField("select [Score] from [PerfEvalScheme] where ([PathID] = " & Session("PathID") & ")", "Score")}

                If (IsNull(Score(0))) Then Score(0) = 0

                If (IsNull(Score(1))) Then Score(1) = 0

                If (Score(0) = 0 AndAlso Score(1) > 0) Then Score(0) = Score(1)

                lblScore.Text = Score(0).ToString(NumericFormat)




            End If

            'Dim EncryptedURL As String = UrlEncode(CryptoEncrypt("<type=load><id=PerformanceSwire><param0=" & Session("PathID") & "><param1=" & EvalDate(0).ToString("yyyy-MM-dd HH:mm:ss") & ">", EncPwd, SaltPwd, 5, EncVectorPwd, 256))

            Dim EncryptedURL As String = UrlEncode(CryptoEncrypt("<type=load><id=Evaluation><param0=" & Session("PathID") & "><param1=" & EvalDate(0).ToString("yyyy-MM-dd HH:mm:ss") & ">", EncPwd, SaltPwd, 5, EncVectorPwd, 256))

            'cmdEvaluation.Attributes.Add("onclick", "window.parent.lpPage.Show(); window.parent.frames[1].cpPage.PerformCallback('Save\ Print'); window.parent.frames[1].hPanel.Set('params', '" & EncryptedURL & "');")

            cmdEvaluation.Attributes.Add("onclick", "window.parent.reset(); window.open('../reportsview.aspx?params=" & EncryptedURL & "', 'open');")

        End If

        If (GetArrayItem(Nothing, "eSecurity.ADEnabled")) AndAlso (Not IsNull(GetArrayItem(Nothing, "eSecurity.ADServer")) AndAlso GetArrayItem(Nothing, "eSecurity.ADLogon")) Then cmdSignout.Visible = False

    End Sub

#End Region

End Class